import 'dart:developer' as dev;

import 'package:iscs_common/iscs_common.dart';
import '../config/app_config.dart';
import 'package:get/get.dart';
import 'package:get_storage/get_storage.dart';

initAppConfig() async {
  dev.log('initialize config', name: AppConfig.packageName);
  ConfigService configService = ConfigService();
  configService.baseUrl = AppConfig.iscsBaseUrl;
  Response response = await configService.getPublicConfigurationAsKeyValue(
      [AppConfig.configCode],
      deploymentId: AppConfig.deploymentId);

  if (response.statusCode == 200) {
    dev.log('load remote config with response body: ${response.body}',
        name: AppConfig.packageName);
    await _storeRemoteConfig(response.body?[AppConfig.configCode]?["parameters"]);
  } else {
    // throw DetailsException("Failed to load application config", details: {
    //   'responseCode': response.statusCode,
    //   'responseBody': response.bodyString
    // });
    await _storeRemoteConfig({"vncitizens_danhba_khancap.tag_category":"620cbded2e28fa5c81b53637","vncitizens_account.placeTypeCategoryId":"61375edc4add381ff03978b9","vncitizens_place.centerLocation":{"lat":10.798543,"long":106.6931094},"vncitizens_common.minio":{"connect":{"endPoint":"storage-cqs.vnpt.vn","accessKey":"icode","secretKey":"ssss6666"},"serviceUrl":"https://storage-cqs.vnpt.vn/","bucket":"master","region":"us-east-1","pathPrefix":"mobile.vnCitizens","bucketNamePrefix":"icode-"},"vncitizens_moitruong.config":{"defaultLocation":{"latitude":10.3553562,"longitude":106.3854084}},"vncitizens_home.weather":{"key":"856822fd8e22db5e1ba48c0e7d69844a"},"flutter_vncitizens.iosFirebaseOptions":{"apiKey":"AIzaSyCv05GiGcMd_K3-JBAUrlvVG8sE0r1bml4","appId":"1:52472714807:ios:09c56de5a58ef0421191b2","messagingSenderId":"52472714807","projectId":"mnhai-vncitizens","storageBucket":"mnhai-vncitizens.appspot.com","iosClientId":"com.googleusercontent.apps.52472714807-mrmh01la5mk2k8c4k6oa32o5fhr793sf","iosBundleId":"vn.vnpt.digo.vncitzens.flutter.app.dev"},"vncitizens_setting.appInfo":{"shareTitle":"Chia sẻ ứng dụng","shareChooserTitle":"Chia sẻ ứng dụng","name":"Ứng dụng công dân số","link":"https://apps.apple.com/vn/app/mindnode-mind-map-outline/id1289197285?mt=12","linkCHPlay":"https://play.google.com/store/apps/details?id=com.google.android.apps.searchlite","linkAppStore":"https://apps.apple.com/vn/app/mindnode-mind-map-outline/id1289197285?mt=12"},"vncitizens_common.api_endpoint":{"iscs":"https://iscsapidev.digigov.vn","vncc":"https://apidev.digigov.vn","bioid":"https://gw-bioid.vnpt.vn","administrativeDocument":{"tokenEndpoint":"https://api.quangnam.gov.vn/token","apiEndpoint":"https://apidev.digigov.vn/vncc/document"},"quangnam":{"tokenEndpoint":"https://api.quangnam.gov.vn/token","apiEndpoint":"https://api.quangnam.gov.vn/apiNcovQuangNam/1.0"}},"vncitizens_home.app":{"version":"1.0.0","updateRequired":false},"vncitizens_portal.newsResources":[{"name":"Quảng Nam","tokenEndpoint":"https://api.quangnam.gov.vn/token","apiEndpoint":"https://api.quangnam.gov.vn/apiNcovQuangNam/1.0","username":"qW97Cno7ImUtW83lCuAfyLjHVOga","password":"g0QN7GCjO2VSI4PshNf4pmD1Pc0a","active":true,"defaultCategories":[{"ChuyenMucID":121,"TenChuyenMuc":"Thông tin cần biết"},{"ChuyenMucID":120,"TenChuyenMuc":"Tin tức"}]}],"vncitizens_common.authenticator":{"oidcTokenEndpoint":"https://iscsoidcdev.digigov.vn/auth/realms/iscs/protocol/openid-connect/token","client_id":"iscs-web-ma","scope":"openid","bioid":{"consumerKey":"mMCYKP9NpWbDF3Jj1PygRrFkS7ka","consumerSecret":"gDZixidvbF12jE2q17jSCAX7Re8a"},"administrativeDocument":{"consumerKey":"qW97Cno7ImUtW83lCuAfyLjHVOga","consumerSecret":"g0QN7GCjO2VSI4PshNf4pmD1Pc0a"}},"vncitizens_place.hcm_opendata":{"urlEndPoint":"https://opendata.hochiminhcity.gov.vn/api","schoolCategoryResourceId":"e9128ffd-36a6-4dc2-adf0-9e0fb285352f"},"vncitizens_petition.vcall":{"avatarReceiver":"https://phunugioi.com/wp-content/uploads/2020/10/hinh-anh-avatar-de-thuong-cute.jpg","dataOptions":{"avatarUrl":"https://haycafe.vn/wp-content/uploads/2021/11/Anh-avatar-dep-chat-lam-hinh-dai-dien.jpg"},"tokenCustomer":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJtYW5hZ2VyLmRpZ29AZ21haWwuY29tIiwicGhvbmUiOiIwODE3MTYwNjk0IiwiZGF0ZV9jcmVhdGUiOiIyMDIyLTAyLTE1IDE1OjU2OjA1IiwiaXNzIjoidWNjIiwiY29tcGFueSI6IlZOUFQgSVQiLCJmdWxsbmFtZSI6InZuQ2l0aXplbnMiLCJlbWFpbCI6Im1hbmFnZXIuZGlnb0BnbWFpbC5jb20ifQ.o0pgU7DVZD876hv3KngWOqN8QIzP1nAd4aCUBrP3XMo","dest":["1022"],"desName":"Tổng đài 1022"},"vncitizens_account.loginConfig":{"x":3,"p":10,"y":5,"q":20},"vncitizens_queue.api_endpoint":{"api":"https://apitest.vnptigate.vn","sso":"https://ssotest.vnptigate.vn/auth/realms/digo/protocol/openid-connect/token","client_id":"web-citizens-public","client_secret":"c3517bcf-8361-4cbd-b628-d6cd327309b6","agency-id":"6098ff348e568b892581defb","parent-id":"5fdabc0c80b8614b0f86d12b"},"vncitizens_garbage_schedule.place":{"province":{"id":"61c2a88891a79d04f3d7e65d","name":"Tiền Giang"},"nation":{"id":"61375edca9071e489fb95f2d","name":"Việt Nam"}},"vncitizens_common.vietbando":{"urlEndPoint":"https://developers.vietbando.com/V2/Service/PartnerPortalservice.svc/rest/SearchAll","RegisterKey":"11731ae0-a8e8-4a98-8741-f0cbb13cf780"},"vncitizens_common.quangnamAccount":{"username":"qW97Cno7ImUtW83lCuAfyLjHVOga","password":"g0QN7GCjO2VSI4PshNf4pmD1Pc0a"},"flutter_vncitizens.androidFirebaseOptions":{"apiKey":"AIzaSyCr2d7VK-_8h74xcCq6RSb4nIM5qriNOIc","appId":"1:52472714807:android:e6e5dc22a07638d11191b2","messagingSenderId":"52472714807","projectId":"mnhai-vncitizens","storageBucket":"mnhai-vncitizens.appspot.com"},"vncitizens_account.smsConfigId":"6086394ead5cb9729ae48f5e","vncitizens_account.citizenIssuerTagId":"61375edceacd7187a219f77c","vncitizens_camera.config":{"cameraTagCategoryId":"624e3642a3088a48c09d2900","defaultLocation":{"latitude":10.3553562,"longitude":106.3854084}},"vncitizens_account.emailConfigId":"622ad4965adf117825373716","vncitizens_setting.instructionLink":"https://youtu.be/sqxc8L0TwY8","vncitizens_account.defaultNationId":"61375edca9071e489fb95f2d","vncitizens_home.menu":[{"groupName":"duoc quan tam nhat","menu":[{"icon":"packages/vncitizens_home/assets/images/menu/danh_ba_khan_cap.png","name":"danh ba khan cap","route":"/vncitizens_danhba_khancap"},{"icon":"packages/vncitizens_home/assets/images/menu/cong_thong_tin.png","name":"cong thong tin","route":"/vncitizens_portal"},{"icon":"packages/vncitizens_home/assets/images/menu/dich_vu_cong.png","name":"dich vu cong","deeplink":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/bat_so_xep_hang.png","name":"bat so xep hang","requiredLogin":true,"route":"/vncitizens_queue"},{"icon":"packages/vncitizens_home/assets/images/menu/phan_anh_kien_nghi.png","name":"phan anh kien nghi","route":"/vncitizens_petition/list"},{"icon":"packages/vncitizens_home/assets/images/menu/phan_anh_kien_nghi.png","name":"chi tiet phan anh","route":"/vncitizens_petition/detail"},{"icon":"packages/vncitizens_home/assets/images/menu/phan_anh_kien_nghi.png","name":"gui phan anh","route":"/vncitizens_petition/create"},{"icon":"packages/vncitizens_home/assets/images/menu/tim_kiem_dia_diem.png","name":"tim kiem dia diem","route":"/vncitizens_place"},{"icon":"packages/vncitizens_home/assets/images/menu/camera.png","name":"camera","route":"/vncitizens_camera"},{"icon":"packages/vncitizens_home/assets/images/menu/moi_truong.png","name":"moi truong","route":"/vncitizens_moitruong"},{"icon":"packages/vncitizens_home/assets/images/menu/van_ban_nha_nuoc.png","name":"van ban nha nuoc","route":"/vncitizens_administrative_document"},{"icon":"packages/vncitizens_home/assets/images/menu/goi_phan_anh.png","name":"goi phan anh","requiredLogin":true,"route":"/vncitizens_petition"},{"icon":"packages/vncitizens_home/assets/images/menu/garbage_truck.png","name":"lich thu gom rac","route":"/vncitizens_garbage_schedule"},{"icon":"packages/vncitizens_home/assets/images/menu/rating.png","name":"danh gia can bo","deeplink":"https://youtube.com"}]},{"groupName":"dich vu khac","menu":[{"icon":"packages/vncitizens_home/assets/images/menu/phong_chong_dich_benh.png","name":"phong chong dich benh","inAppBrowserUrl":"https://pccovid.gov.vn/"},{"icon":"packages/vncitizens_home/assets/images/menu/chat_tu_van_covid.png","name":"chat tu van covid","inAppBrowserUrl":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/thong_tin_can_biet.png","name":"thong tin can biet","deeplink":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/an_sinh_xa_hoi.png","name":"an sinh xa hoi","deeplink":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/kinh_te.png","name":"kinh te","deeplink":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/du_lich.png","name":"du lich","deeplink":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/dat_dai.png","name":"dat dai","deeplink":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/vnpt_pay.png","name":"VNPT PAY","route":"/vncitizens_payment","child":[{"icon":"packages/vncitizens_home/assets/images/menu/vnpt_pay_electronic.png","name":"tien dien","route":"/vncitizens_payment/pay_electronic"},{"icon":"packages/vncitizens_home/assets/images/menu/vnpt_pay_water.png","name":"tien nuoc","route":"/vncitizens_payment/pay_water"},{"icon":"packages/vncitizens_home/assets/images/menu/vnpt_pay_telecom_data.png","name":"Cước viễn thông","route":"/vncitizens_payment/pay_telecom_data"},{"icon":"packages/vncitizens_home/assets/images/menu/vnpt_pay_fee.png","name":"Học phí","route":"/vncitizens_payment/pay_fee"}]},{"icon":"packages/vncitizens_home/assets/images/menu/viettel_pay.png","name":"VIETTEL PAY","deeplink":"https://youtube.com"},{"icon":"packages/vncitizens_home/assets/images/menu/momo.png","name":"MOMO","deeplink":"https://youtube.com"},{"networkIcon":"https://i.pinimg.com/originals/32/28/82/322882aa4e9e1cd909b7cf4f61c21e9a.png","name":"SMS","sms":"0987654321"},{"networkIcon":"https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Circle-icons-mail.svg/1024px-Circle-icons-mail.svg.png","name":"EMAIL","email":"example@gmail.com"},{"networkIcon":"https://cdn4.iconfinder.com/data/icons/social-media-2097/94/phone-512.png","name":"CALL","call":"0987654321"}]}],"vncitizens_danhba_khancap.location_call":{"urlEndPoint":"https://eoc.tphcm.gov.vn/api/app11x/update-phonebook","secert_key":"NcRuoO6DjZDfzyxGZkVHOdYaMxxFlJ","data":[{"phone":"113","number":"02836228400"},{"phone":"114","number":"02836228440"},{"phone":"115","number":"02836228480"}]},"vncitizens_common.hcm_opendata":{"urlEndPoint":"https://opendata.hochiminhcity.gov.vn/api","schoolCategoryResourceId":"e9128ffd-36a6-4dc2-adf0-9e0fb285352f"},"vncitizens_place.tagCategoryId":"765f1f77bcf86cd799439010","vncitizens_place.config_type_view":0,"vncitizens_home.banner":{"images":["https://i.pinimg.com/originals/7f/f2/96/7ff296fa52183be163a3761be66ce9af.jpg","https://i.pinimg.com/736x/c1/86/3e/c1863ee9a1ed436f3cb5e71b2ae995a0.jpg","https://i.pinimg.com/550x/96/f7/33/96f733006534aa2da5b48aeaa24aa5a4.jpg"]},"vncitizens_home.is_group_menu":true});
  }
}

Future<void> _storeRemoteConfig(dynamic config) async {
  List<String> initialized = [];
  if (config is Map) {
    for (MapEntry<dynamic, dynamic> entry in config.entries) {
      var arr = entry.key.toString().split(".");
        var boxName = arr.first;
        var storeKey = arr.length != 2 || arr[1].isEmpty ? AppConfig.defaultConfigKey : arr[1];
        if (!initialized.contains(boxName)) {
          initialized.add(boxName);
          await GetStorage.init(boxName);
          dev.log("INIT STORAGE " + boxName + " SUCCESSFULLY !!!", name: AppConfig.packageName);
        }
        await GetStorage(boxName).write(storeKey, entry.value);
        // dev.log('store remote config box $boxName, key $storeKey', name: AppConfig.packageName);
    }
  } else {
    dev.log('remote config is not stored because it is not a map or empty',
        name: AppConfig.packageName);
  }
}
